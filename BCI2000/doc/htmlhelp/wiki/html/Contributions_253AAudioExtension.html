<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" >
<head>
<title>Contributions:AudioExtension - BCI2000 Help</title>
<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<meta name="keywords" content="Contributions:AudioExtension,Contributions:AudioExtension,Contributions:Extensions,Programming Reference:Events,User Reference:Logging Input" />
<link rel="shortcut icon" href="../../favicon.ico" />
<link rel='stylesheet' type='text/css' media='print' href='../skins/common/wikiprintable.css' />
<link rel="stylesheet" href="../skins/common/wikistandard.css@1" type="text/css" />
<link rel="stylesheet" href="../skins/common/common.css" type="text/css" />
<link rel="stylesheet" href="../skins/common/htmlhelp.css" type="text/css" />

<style type='text/css'>
a.new, #quickbar a.new { color: #CC2200; }
.editsection { display: none; }
#quickbar { position: absolute; top: 4px; left: 4px;  }
#article { margin-left: 152px; margin-right: 4px; }
</style>
</head>

<body bgcolor='#FFFFFF'>

<div id='content'>
<div id='topbar'>
<table border='0' cellspacing='0' width='98%'>
<tr>
</tr>
</table>
</div>

<div id='article'>
<h1 class="pagetitle">AudioExtension</h1><p class="subtitle">Contributions</p><hr class="sep" /><table id="toc" class="toc" summary="Contents"><tr><td><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class='toclevel-1'><a href="Contributions%253AAudioExtension.html#Synopsis"><span class="tocnumber">1</span> <span class="toctext">Synopsis</span></a></li>
<li class='toclevel-1'><a href="Contributions%253AAudioExtension.html#Location"><span class="tocnumber">2</span> <span class="toctext">Location</span></a></li>
<li class='toclevel-1'><a href="Contributions%253AAudioExtension.html#Versioning"><span class="tocnumber">3</span> <span class="toctext">Versioning</span></a>
<ul>
<li class='toclevel-2'><a href="Contributions%253AAudioExtension.html#Authors"><span class="tocnumber">3.1</span> <span class="toctext">Authors</span></a></li>
<li class='toclevel-2'><a href="Contributions%253AAudioExtension.html#Version_History"><span class="tocnumber">3.2</span> <span class="toctext">Version History</span></a></li>
<li class='toclevel-2'><a href="Contributions%253AAudioExtension.html#Source_Code_Revisions"><span class="tocnumber">3.3</span> <span class="toctext">Source Code Revisions</span></a></li>
<li class='toclevel-2'><a href="Contributions%253AAudioExtension.html#Todo"><span class="tocnumber">3.4</span> <span class="toctext">Todo</span></a></li>
<li class='toclevel-2'><a href="Contributions%253AAudioExtension.html#Known_Issues"><span class="tocnumber">3.5</span> <span class="toctext">Known Issues</span></a></li>
</ul>
</li>
<li class='toclevel-1'><a href="Contributions%253AAudioExtension.html#Functional_Description"><span class="tocnumber">4</span> <span class="toctext">Functional Description</span></a></li>
<li class='toclevel-1'><a href="Contributions%253AAudioExtension.html#Integration_into_BCI2000"><span class="tocnumber">5</span> <span class="toctext">Integration into BCI2000</span></a></li>
<li class='toclevel-1'><a href="Contributions%253AAudioExtension.html#Block_Diagram"><span class="tocnumber">6</span> <span class="toctext">Block Diagram</span></a></li>
<li class='toclevel-1'><a href="Contributions%253AAudioExtension.html#Parameters"><span class="tocnumber">7</span> <span class="toctext">Parameters</span></a>
<ul>
<li class='toclevel-2'><a href="Contributions%253AAudioExtension.html#EnableAudioExtension"><span class="tocnumber">7.1</span> <span class="toctext">EnableAudioExtension</span></a></li>
<li class='toclevel-2'><a href="Contributions%253AAudioExtension.html#AudioMixer"><span class="tocnumber">7.2</span> <span class="toctext">AudioMixer</span></a></li>
<li class='toclevel-2'><a href="Contributions%253AAudioExtension.html#AudioInputDevice"><span class="tocnumber">7.3</span> <span class="toctext">AudioInputDevice</span></a></li>
<li class='toclevel-2'><a href="Contributions%253AAudioExtension.html#AudioOutputDevice"><span class="tocnumber">7.4</span> <span class="toctext">AudioOutputDevice</span></a></li>
<li class='toclevel-2'><a href="Contributions%253AAudioExtension.html#AudioInputFile"><span class="tocnumber">7.5</span> <span class="toctext">AudioInputFile</span></a></li>
<li class='toclevel-2'><a href="Contributions%253AAudioExtension.html#AudioRecordInput"><span class="tocnumber">7.6</span> <span class="toctext">AudioRecordInput</span></a></li>
<li class='toclevel-2'><a href="Contributions%253AAudioExtension.html#AudioRecordOutput"><span class="tocnumber">7.7</span> <span class="toctext">AudioRecordOutput</span></a></li>
<li class='toclevel-2'><a href="Contributions%253AAudioExtension.html#AudioRecordingFormat"><span class="tocnumber">7.8</span> <span class="toctext">AudioRecordingFormat</span></a></li>
<li class='toclevel-2'><a href="Contributions%253AAudioExtension.html#AudioInputFilterbank.2C_AudioOutputFilterbank"><span class="tocnumber">7.9</span> <span class="toctext">AudioInputFilterbank, AudioOutputFilterbank</span></a></li>
<li class='toclevel-2'><a href="Contributions%253AAudioExtension.html#AudioEnvelopeSmoothing"><span class="tocnumber">7.10</span> <span class="toctext">AudioEnvelopeSmoothing</span></a></li>
</ul>
</li>
<li class='toclevel-1'><a href="Contributions%253AAudioExtension.html#State_Variables"><span class="tocnumber">8</span> <span class="toctext">State Variables</span></a>
<ul>
<li class='toclevel-2'><a href="Contributions%253AAudioExtension.html#Audio.5BIn.2FOut.5DEnvelope.5B0-3.5D"><span class="tocnumber">8.1</span> <span class="toctext">Audio[In/Out]Envelope[0-3]</span></a></li>
<li class='toclevel-2'><a href="Contributions%253AAudioExtension.html#AudioFrame"><span class="tocnumber">8.2</span> <span class="toctext">AudioFrame</span></a></li>
</ul>
</li>
<li class='toclevel-1'><a href="Contributions%253AAudioExtension.html#See_also"><span class="tocnumber">9</span> <span class="toctext">See also</span></a></li>
</ul>
</td></tr></table>
<a name="Synopsis"></a><h2>Synopsis</h2>
<p>An environment extension which manages multichannel, low latency audio I/O.
</p>
<a name="Location"></a><h2>Location</h2>
<p><a href="http://www.bci2000.org/svn/trunk/src/contrib/Extensions/AudioExtension" class='external free' title="http://www.bci2000.org/svn/trunk/src/contrib/Extensions/AudioExtension" rel="nofollow">http://www.bci2000.org/svn/trunk/src/contrib/Extensions/AudioExtension</a>
</p>
<a name="Versioning"></a><h2>Versioning</h2>
<a name="Authors"></a><h3>Authors</h3>
<p>Griffin Milsap (griffin.milsap@gmail.com)
</p>
<a name="Version_History"></a><h3>Version History</h3>
<ul><li> 2012/06/11: Initial public release;
</li></ul>
<a name="Source_Code_Revisions"></a><h3>Source Code Revisions</h3>
<ul><li>Initial development: 4095
</li><li>Tested under: 4095
</li><li>Known to compile under: 4095
</li><li>Broken since: --
</li></ul>
<a name="Todo"></a><h3>Todo</h3>
<ul><li> Fix Known Issues
</li><li> Add per-sample resolution to envelopes
</li></ul>
<a name="Known_Issues"></a><h3>Known Issues</h3>
<ul><li> Leaving the module in halted state exhibits some sort of bug regarding state logging.  When running state is resumed, envelope states may fail to update for 15-30 seconds. The bug seems to be unrelated to how long system was halted -- Not sure if this is an issue with the extension itself, or an issue with the <a href="Programming_Reference%253AEvents.html" title="Programming Reference:Events">bcievent</a> interface.  This bug will never happen on the first run after BCI2000 is started up.  If you do see the behavior, either wait for it to go away or restart BCI2000 and perform a new recording.
</li><li> Bandpass filtering in filterbanks doesn't appear to function correctly.
</li><li> AudioExtension processes audio in a separate thread and the internal audio callback is called from yet-another context (Sometimes a system interrupt).  In order to prevent deadlock, the Audio callback must not lock or wait for external threads.  As such, it will simply copy the last good audio buffer to the output stream if the audio thread has not posted new data to use yet.  This can result in slowed "timestretching" effects on audio input files if the audio thread cannot keep up with the audio callbacks.  To prevent this behavior, ensure your audio block size is large enough (at least 1024 frames).  If you are using a lower latency audio API (such as ASIO) you are probably okay to use audio block sizes around 512 frames.  Either way, be mindful that audio playback may not necessarily operate in real-time and you will receive NO WARNING WHATSOEVER when it fails to.
</li></ul>
<a name="Functional_Description"></a><h2>Functional Description</h2>
<p>Experiments which require audio input or real-time audio synthesis based on system state are now possible with the AudioExtension.  This extension is capable of recording multiple channels of audio input, synthesizing tones or noise, and reading encoded audio files.  These channels are input to a mixing matrix which mixes those inputs to multiple channels of audio output.  Both input and output are run through a simple filterbank, then they have their envelope extracted and logged into states via the bcievent interface.  Audio input and output channels can be recorded into audio files losslessly and can be resynchronized offline.  The mixing matrix is a matrix of expressions which can be used to dynamically change audio mixing based on the system state.
</p>
<a name="Integration_into_BCI2000"></a><h2>Integration into BCI2000</h2>
<p>Compile the extension into your source module by enabling contributed extensions in your CMake configuration.  You can do this by going into your root build folder and deleting <code>CMakeCache.txt</code> and re-running the project batch file, or by running <code>cmake -i</code> and enabling <b>BUILD_AUDIOEXTENSION</b>.  Once the extension is built into the source module, enable it by starting the source module with the <code>--EnableAudioExtension=1</code> command line argument (NB, as explained below, the numeric value here matters, and denotes the audio API to be used:  =1 means DirectSound).
</p>
<a name="Block_Diagram"></a><h2>Block Diagram</h2>
<p><a href="../images/1/1e/AudioExtensionBlockDiagram.png" class="image" title="Image:AudioExtensionBlockDiagram.png"><img src="../images/1/1e/AudioExtensionBlockDiagram.png" alt="Image:AudioExtensionBlockDiagram.png" width="654" height="686" longdesc="/wiki/index.php/Image:AudioExtensionBlockDiagram.png" /></a>
</p>
<a name="Parameters"></a><h2>Parameters</h2>
<p>The AudioExtension is configured in the Source tab within the AudioExtension section.  The configurable parameters are:
</p>
<a name="EnableAudioExtension"></a><h3>EnableAudioExtension</h3>
<p>Enables/Disables the AudioExtension.  This parameter performs double-duty as an audio host API selector.  The following values of this parameter are valid.  NOTE: Not all audio APIs are available on all platforms.
</p>
<ul><li><ul><li>[0] - Disabled
</li><li>[1] - DirectSound
</li><li>[2] - MME
</li><li>[3] - ASIO
</li><li>[4] - SoundManager
</li><li>[5] - CoreAudio
</li><li>[6] - Disabled
</li><li>[7] - OSS
</li><li>[8] - ALSA
</li><li>[9] - AL
</li><li>[10] - BeOs
</li><li>[11] - WDMKS
</li><li>[12] - JACK
</li><li>[13] - WASAPI
</li><li>[14] - AudioScienceHPI
</li></ul>
</li></ul>
<a name="AudioMixer"></a><h3>AudioMixer</h3>
<p>This matrix of expressions mixes input (rows) to output(columns).  It must be dimensioned with exactly <code>n</code> columns where <code>n</code> is the number of outputs.  Row labels define the input source.  Change row labels by double clicking on the row.  The following inputs are valid row labels.
</p>
<ul><li><code>X</code> - This is automatically interpreted as INPUT[X]
</li><li><code>INPUT[X]</code> - This input will come from channel X on the sound card input.
</li><li><code>FILE[X]</code> - This input will come from channel X in the AudioInputFile.
</li><li><code>TONE[X]</code> - This input will be a synthesized sine wave with the frequency of X Hz.
</li><li><code>NOISE[X]</code> - This input will be generated white noise at X Hz.  NOTE: NOISE[] is white noise at the audio sampling rate (which defaults to 44100)
</li></ul>
<a name="AudioInputDevice"></a><h3>AudioInputDevice</h3>
<p>The index for the device to use as the audio input device on the current Host API.  See the operator log after "Set Config" for valid device indices on the selected host API.  A value of -1 for this parameter selects the default input device on this host API.
</p>
<a name="AudioOutputDevice"></a><h3>AudioOutputDevice</h3>
<p>The index for the device to use as the audio input device on the current Host API.  See the operator log after "Set Config" for valid device indices on the selected host API.  A value of -1 for this parameter selects the default output device on this host API.
</p>
<a name="AudioInputFile"></a><h3>AudioInputFile</h3>
<p>Audio file to use as audio input to AudioMixer.  The selected file can have any non-zero number of channels and be encoded in almost any format (except MP3), but MUST be encoded at 44100 Hz.
</p>
<a name="AudioRecordInput"></a><h3>AudioRecordInput</h3>
<p>Enables/Disables recording of audio data to a file in the DataDirectory.
</p>
<a name="AudioRecordOutput"></a><h3>AudioRecordOutput</h3>
<p>Enables/Disables recording of audio data to a file in the DataDirectory.
</p>
<a name="AudioRecordingFormat"></a><h3>AudioRecordingFormat</h3>
<p>Changes the file format and encoding options of the recorded output files.  This parameter has the following three options:
</p>
<ul><li>Raw - Records to 16 bit Microsoft formatted WAV files with no compression.  These files open directly in MATLAB if that's interesting to you.
</li><li>Lossless - Records to FLAC formatted files.  These files are slightly smaller than RAW files, but have no quality loss.
</li><li>Lossy - Records to Ogg Vorbis files.  These files are similar to MP3 but do not have the associated licensing issues.  They are compressed using a lossy algorithm, so the resulting files are very small but sound slightly worse than lossless encoding.  This format is good for long recordings where perfect quality is not necessary.
</li></ul>
<a name="AudioInputFilterbank.2C_AudioOutputFilterbank"></a><h3>AudioInputFilterbank, AudioOutputFilterbank</h3>
<p>A filterbank which filters audio input and output before rectification/smoothing for envelope extraction.  These butterworth filters will not be applied to the audible signal.  The format of the filter bank is as follows:
</p>
<ul><li>Type - The characteristic of the filter.  The following values are valid.
<ul><li>Lowpass - Creates a low pass filter
</li><li>Highpass - Creates a high pass filter
</li><li>Bandpass - Creates a band pass filter <a href="Contributions%253AAudioExtension.html#Known_Issues" title="Contributions:AudioExtension">*See Known Issues*</a>
</li><li>Bandstop - Creates a band stop, or notch filter
</li></ul>
</li><li>Order - The order of the filter model.  Higher order filters are more accurate but more expensive computationally.
</li><li>Cutoff1 - The cutoff frequency for Lowpass and Highpass filters, and the cut-on frequency for Bandpass and Bandstop filters.
</li><li>Cutoff2 - The cut-off frequency for Bandpass and Bandstop filters.
</li></ul>
<p>The matrix can have as many rows as necessary to filter the signal.  Filters can be applied in any order and their transfer functions are multiplied before filtering occurs.
</p>
<a name="AudioEnvelopeSmoothing"></a><h3>AudioEnvelopeSmoothing</h3>
<p>The cutoff frequency for the low pass filter which is applied to the filtered and full-wave rectified audio data.  This should be set to the highest frequency you want to see in the resulting audio envelope.
</p>
<a name="State_Variables"></a><h2>State Variables</h2>
<p>The AudioExtension outputs the following state variables:
</p>
<a name="Audio.5BIn.2FOut.5DEnvelope.5B0-3.5D"></a><h3>Audio[In/Out]Envelope[0-3]</h3>
<p>These are the envelope values of each channel (up to channel 4) of the audio inputs and outputs (in the AudioMixer matrix).  These 16 bit unsigned values correspond to the resulting envelope after the audio envelope extraction.  For architectural reasons, it is not possible to publish states after system startup, so you are limited to four channels of input and output.  The AudioExtension can be easily modified to change the number of channels by editing the <code>#define NUM_INPUT_ENVELOPES 4</code> and <code>#define NUM_OUTPUT_ENVELOPES</code> lines in AudioExtension.cpp, and recompiling your source module.
</p>
<a name="AudioFrame"></a><h3>AudioFrame</h3>
<p>This 32 bit unsigned number corresponds to the current frame of audio data in the recorded output files.  This can be used to resynchronize the lossless audio to the resulting .dat file offline.  Audio is sampled internally at 44100 Hz, so this number will roll over once every 27 hours or so.
</p>
<a name="See_also"></a><h2>See also</h2>
<p><a href="User_Reference%253ALogging_Input.html" title="User Reference:Logging Input">User Reference:Logging Input</a>, <a href="Contributions%253AExtensions.html" title="Contributions:Extensions">Contributions:Extensions</a>
</p>
<div class="printfooter">
</div>

</div><br style="clear:both" />

<div id='footer'><table border="0" cellspacing="0"><tr><td width='152' rowspan='1'>&nbsp;</td><td class='bottom' align='left' valign='top'></td></tr></table>
</div>
</div>

<div id='quickbar'>
<table class="image"><caption align="bottom"><h2>BCI2000 Help</h2></caption><tr><td><a href="BCI2000_Help.html"><img src='../../images/bci2000logo_small.png' height=100 width=100 alt='[BCI2000 Help]' /></a></td></tr></table>
<hr class='sep' /><a href="User_Tutorial%253ABCI2000_Tour.html">Getting Started</a><br />
<a href="User_Reference%253AContents.html">User Manual</a><br />
<a href="Technical_Reference%253AContents.html">Technical Reference</a><br />
<a href="Programming_Reference%253AContents.html">Programming Manual</a><br />
<a href="Contributions%253AContents.html">Contributions</a><br />
<ul><li><a href="Contributions%253AADCs.html">Data Acquisition</a></li>
<li><a href="Contributions%253AFileWriters.html">File Formats</a></li>
<li><a href="Contributions%253ASignalProcessing.html">Signal Processing</a></li>
<li><a href="Contributions%253AApplications.html">Applications</a></li>
<li><a href="Contributions%253ATools.html">Tools</a></li>
</ul><hr class='sep' />
<a href="BCI2000_Glossary.html">BCI2000 Glossary</a><br />
</div>

</body></html>